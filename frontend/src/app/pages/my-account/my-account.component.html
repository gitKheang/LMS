<div class="min-h-screen bg-background">
  <main class="container mx-auto px-4 py-8">
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-foreground">My Account</h1>
      <p class="text-muted-foreground">Manage your library loans and borrowing history</p>
    </div>

    <!-- Notification Alert - Shows only one at a time -->
    @if (latestUnreadNotification(); as notification) {
      <div class="mb-8">
        <div class="rounded-lg border-2 border-destructive/30 bg-destructive/5 p-4">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
              <div class="flex h-10 w-10 items-center justify-center rounded-full bg-destructive/10">
                <lucide-icon name="alert-triangle" class="h-5 w-5 text-destructive"></lucide-icon>
              </div>
            </div>
            <div class="flex-1">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <div class="flex items-center gap-2">
                    <h3 class="font-semibold text-destructive">{{ notification.title }}</h3>
                    @if (remainingNotificationsCount() > 0) {
                      <span class="rounded-full bg-destructive/10 px-2 py-0.5 text-xs font-medium text-destructive">
                        +{{ remainingNotificationsCount() }} more
                      </span>
                    }
                  </div>
                  <p class="mt-1 text-sm text-foreground">{{ notification.message }}</p>
                  <p class="mt-2 text-xs text-muted-foreground">
                    <lucide-icon name="clock" class="inline h-3 w-3 mr-1"></lucide-icon>
                    {{ formatNotificationDate(notification.createdAt) }}
                  </p>
                </div>
                <button
                  type="button"
                  (click)="dismissNotification(notification)"
                  class="rounded-md border border-border bg-background px-3 py-1.5 text-xs font-medium text-muted-foreground hover:bg-muted"
                >
                  Dismiss
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    }

    <div class="mb-8 rounded-lg border border-border bg-card p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-card-foreground">Account Information</h2>
        <button
          type="button"
          (click)="openChangePassword()"
          class="inline-flex items-center gap-2 rounded-md border border-border px-3 py-1.5 text-sm font-medium text-foreground hover:bg-muted transition-colors"
        >
          <lucide-icon name="key" class="h-4 w-4"></lucide-icon>
          Change Password
        </button>
      </div>
      <div class="mt-4 space-y-2 text-sm">
        <div class="flex items-center justify-between">
          <span class="text-muted-foreground">Name:</span>
          <span class="font-medium text-foreground">{{ auth.user()?.name }}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-muted-foreground">Email:</span>
          <span class="font-medium text-foreground">{{ auth.user()?.email }}</span>
        </div>
        @if (auth.user()?.studentId) {
          <div class="flex items-center justify-between">
            <span class="text-muted-foreground">Student ID:</span>
            <span class="font-medium text-foreground">{{ auth.user()?.studentId }}</span>
          </div>
        }
      </div>
    </div>

    <div class="mb-8 grid gap-6 md:grid-cols-3">
      <div class="rounded-lg border border-border bg-card p-6">
        <div class="flex items-center gap-3">
          <div class="rounded-lg bg-primary/10 p-2">
            <lucide-icon name="book-open" class="h-5 w-5 text-primary"></lucide-icon>
          </div>
          <div>
            <p class="text-2xl font-bold text-foreground">{{ currentLoans().length }}</p>
            <p class="text-sm text-muted-foreground">Active Loans</p>
          </div>
        </div>
      </div>
      <div class="rounded-lg border border-border bg-card p-6">
        <div class="flex items-center gap-3">
          <div class="rounded-lg bg-destructive/10 p-2">
            <lucide-icon name="alert-circle" class="h-5 w-5 text-destructive"></lucide-icon>
          </div>
          <div>
            <p class="text-2xl font-bold text-destructive">{{ overdueCount() }}</p>
            <p class="text-sm text-muted-foreground">Overdue</p>
          </div>
        </div>
      </div>
      <div class="rounded-lg border border-border bg-card p-6">
        <div class="flex items-center gap-3">
          <div class="rounded-lg bg-secondary/50 p-2">
            <lucide-icon name="check-circle" class="h-5 w-5 text-secondary-foreground"></lucide-icon>
          </div>
          <div>
            <p class="text-2xl font-bold text-foreground">{{ pastLoans().length }}</p>
            <p class="text-sm text-muted-foreground">Total Returned</p>
          </div>
        </div>
      </div>
    </div>

    <div class="rounded-lg border border-border bg-card">
      <div class="border-b border-border px-6 py-4">
        <h2 class="text-lg font-semibold">My Loans</h2>
        <p class="text-sm text-muted-foreground">View your current and past book loans</p>
      </div>
      <div class="px-6 pt-4">
        <div class="inline-flex rounded-lg border border-border bg-muted p-1">
          <button
            type="button"
            class="rounded-md px-4 py-2 text-sm font-medium"
            [class.bg-card]="activeTab() === 'current'"
            (click)="setTab('current')"
          >
            Current Loans ({{ currentLoans().length }})
          </button>
          <button
            type="button"
            class="rounded-md px-4 py-2 text-sm font-medium"
            [class.bg-card]="activeTab() === 'history'"
            (click)="setTab('history')"
          >
                Returned ({{ pastLoans().length }})
          </button>
        </div>
      </div>
      <div class="px-6 py-6">
        @if (isLoading()) {
          <div class="flex items-center justify-center py-12">
            <div class="h-8 w-8 animate-spin rounded-full border-2 border-primary border-t-transparent"></div>
          </div>
        } @else if (activeTab() === 'current') {
          @if (currentLoans().length === 0) {
            <div class="flex flex-col items-center gap-3 py-10 text-muted-foreground">
              <lucide-icon name="book-open" class="h-12 w-12"></lucide-icon>
              <p>You have no active loans</p>
            </div>
          } @else {
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm">
                <thead class="text-muted-foreground">
                  <tr>
                    <th class="pb-3 font-medium">Book Title</th>
                    <th class="pb-3 font-medium">Author</th>
                    <th class="pb-3 font-medium">Borrowed Date</th>
                    <th class="pb-3 font-medium">Due Date</th>
                    <th class="pb-3 font-medium">Status</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  @for (loan of currentLoans(); track loan._id) {
                    <tr class="text-foreground">
                      <td class="py-3 font-medium">{{ loan.book.title }}</td>
                      <td>{{ loan.book.author }}</td>
                      <td>{{ formatDate(loan.borrowDate) }}</td>
                      <td class="flex items-center gap-2">
                        <lucide-icon name="clock" class="h-4 w-4 text-muted-foreground"></lucide-icon>
                        {{ formatDate(loan.dueDate) }}
                      </td>
                      <td>
                        <span class="rounded-full px-3 py-1 text-xs font-semibold" [ngClass]="statusClasses(loan.status)">
                          {{ statusLabel(loan.status) }}
                        </span>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        } @else {
          @if (pastLoans().length === 0) {
            <div class="flex flex-col items-center gap-3 py-10 text-muted-foreground">
              <lucide-icon name="check-circle" class="h-12 w-12"></lucide-icon>
              <p>No borrowing history yet</p>
            </div>
          } @else {
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm">
                <thead class="text-muted-foreground">
                  <tr>
                    <th class="pb-3 font-medium">Book Title</th>
                    <th class="pb-3 font-medium">Author</th>
                    <th class="pb-3 font-medium">Borrowed Date</th>
                    <th class="pb-3 font-medium">Returned Date</th>
                    <th class="pb-3 font-medium">Status</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  @for (loan of pastLoans(); track loan._id) {
                    <tr class="text-foreground">
                      <td class="py-3 font-medium">{{ loan.book.title }}</td>
                      <td>{{ loan.book.author }}</td>
                      <td>{{ formatDate(loan.borrowDate) }}</td>
                      <td>{{ formatDate(loan.returnDate) }}</td>
                      <td>
                        <span class="rounded-full px-3 py-1 text-xs font-semibold" [ngClass]="statusClasses(loan.status)">
                          {{ statusLabel(loan.status) }}
                        </span>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        }
      </div>
    </div>
  </main>

  <!-- Change Password Modal -->
  @if (showChangePassword()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-4">
      <div class="w-full max-w-md rounded-xl border border-border bg-card shadow-2xl">
        <div class="flex items-center justify-between border-b border-border px-6 py-4">
          <div>
            <h2 class="text-xl font-semibold text-card-foreground">Change Password</h2>
            <p class="text-sm text-muted-foreground">Enter your current password and choose a new one</p>
          </div>
          <button type="button" class="text-muted-foreground hover:text-foreground" (click)="closeChangePassword()">âœ•</button>
        </div>
        <form class="space-y-4 px-6 py-6" [formGroup]="passwordForm" (ngSubmit)="submitChangePassword()">
          <div class="space-y-2">
            <label class="text-sm font-medium">Current Password</label>
            <div class="relative">
              <input
                formControlName="currentPassword"
                [type]="showCurrentPassword() ? 'text' : 'password'"
                class="w-full rounded-md border border-input bg-background px-3 py-2 pr-10"
                placeholder="Enter current password"
              />
              <button
                type="button"
                class="absolute inset-y-0 right-0 flex items-center px-3 text-muted-foreground hover:text-foreground"
                (click)="toggleCurrentPasswordVisibility()"
              >
                <lucide-icon [name]="showCurrentPassword() ? 'eye-off' : 'eye'" class="h-4 w-4"></lucide-icon>
              </button>
            </div>
            @if (passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched) {
              <p class="text-sm text-destructive">Current password is required</p>
            }
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">New Password</label>
            <div class="relative">
              <input
                formControlName="newPassword"
                [type]="showNewPassword() ? 'text' : 'password'"
                class="w-full rounded-md border border-input bg-background px-3 py-2 pr-10"
                placeholder="Enter new password (min 6 characters)"
              />
              <button
                type="button"
                class="absolute inset-y-0 right-0 flex items-center px-3 text-muted-foreground hover:text-foreground"
                (click)="toggleNewPasswordVisibility()"
              >
                <lucide-icon [name]="showNewPassword() ? 'eye-off' : 'eye'" class="h-4 w-4"></lucide-icon>
              </button>
            </div>
            @if (passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched) {
              <p class="text-sm text-destructive">Password must be at least 6 characters</p>
            }
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Confirm New Password</label>
            <div class="relative">
              <input
                formControlName="confirmPassword"
                [type]="showConfirmPassword() ? 'text' : 'password'"
                class="w-full rounded-md border border-input bg-background px-3 py-2 pr-10"
                placeholder="Confirm new password"
              />
              <button
                type="button"
                class="absolute inset-y-0 right-0 flex items-center px-3 text-muted-foreground hover:text-foreground"
                (click)="toggleConfirmPasswordVisibility()"
              >
                <lucide-icon [name]="showConfirmPassword() ? 'eye-off' : 'eye'" class="h-4 w-4"></lucide-icon>
              </button>
            </div>
            @if (passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched) {
              <p class="text-sm text-destructive">Please confirm your new password</p>
            }
          </div>
          <div class="flex justify-end gap-3 pt-2">
            <button type="button" class="rounded-md border border-border px-4 py-2 text-sm" (click)="closeChangePassword()">Cancel</button>
            <button
              type="submit"
              class="rounded-md bg-primary px-4 py-2 text-sm text-primary-foreground"
              [disabled]="isChangingPassword()"
            >
              {{ isChangingPassword() ? 'Changing...' : 'Change Password' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
